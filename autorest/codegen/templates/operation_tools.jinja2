{% import 'keywords.jinja2' as keywords with context %}
{% macro return_type_annotation(operation, return_type_wrapper, return_type=None) %}
{%- if return_type -%}
{{ return_type }}
{%- else -%}
{{ ((return_type_wrapper | join("[") + "[") if return_type_wrapper else "") ~ ("Optional[" if operation.has_optional_return_type else "" ) ~ ("Union[" if operation.responses | selectattr('has_body') | map(attribute='operation_type_annotation') | unique | list  | length > 1 else "") ~
(operation.responses | selectattr('has_body') | map(attribute='operation_type_annotation') | unique | join(', ')) ~
("]" if operation.responses | selectattr('has_body') | map(attribute='operation_type_annotation')| unique | list | length > 1 else "") ~ ("]" if operation.has_optional_return_type else "") ~ ( ("]" * return_type_wrapper | count ) if return_type_wrapper else "")
if operation.responses | selectattr('has_body') | first
else ((return_type_wrapper | join("[") + "[") if return_type_wrapper else "") ~ ("Optional[" if operation.has_optional_return_type else "" ) ~ "None" ~ ("]" if operation.has_optional_return_type else "") ~ ( ("]" * return_type_wrapper | count ) if return_type_wrapper else "") }}{%- endif -%}{% endmacro %}
{# get async mypy typing #}
{% macro async_return_type_annotation(operation, return_type_wrapper, return_type=None) %}
{{ " -> " + return_type_annotation(operation, return_type_wrapper, return_type) }}{% endmacro %}
{# get sync mypy typing #}
{% macro sync_return_type_annotation(operation, return_type_wrapper, return_type=None) %}
{{ "# type: (...) -> " + return_type_annotation(operation, return_type_wrapper, return_type) }}{% endmacro %}
{# get method signature #}
{% macro _method_signature(operation, parameters, operation_name, async_mode, coroutine, return_type_wrapper, return_type=None, want_self=True) %}
{% import 'keywords.jinja2' as keywords with context %}
{{ "async " if coroutine else "" }}def {{ operation_name }}(
{% if want_self %}
    self,
{% endif %}
{% for param_signature in parameters.method_signature(async_mode) %}
    {{ param_signature }}
{% endfor %}
){{ async_return_type_annotation(operation, return_type_wrapper, return_type) if async_mode }}:
{% endmacro %}

{% macro operation_method_signature(operation, async_mode, coroutine, return_type_wrapper, return_type=None) %}
{{ _method_signature(operation, operation.parameters, operation.python_name, async_mode, coroutine, return_type_wrapper, return_type) }}{% endmacro %}

{% macro request_builder_method_signature(request_builder, is_python_3_file) %}
{{ _method_signature(None, request_builder.parameters, request_builder.name, is_python_3_file, coroutine=False, return_type_wrapper="", return_type="HttpRequest", want_self=False) }}{% endmacro %}

{# content type docstring #}
{% macro content_type_docstring(request_builder) %}
{% set content_type_constant = request_builder.parameters.constant|selectattr("implementation", "equalto", "Method")|selectattr("original_parameter", "equalto", None)|selectattr("in_method_code") | selectattr("serialized_name", "equalto", "content_type") | first  %}
:keyword str content_type: Media type of the body sent to the API. Default value is {{ request_builder.default_content_type_declaration }}.
 Allowed values are: "{{ request_builder.schema_requests | map(attribute="media_types") | sum(start = []) | unique | list | join ('", "')  }}".{% endmacro %}

{# Param docstring #}
{% macro param_documentation_string(parameter) %}:{{ parameter.description_keyword }} {{ parameter.serialized_name }}: {{ parameter.description }}{% endmacro %}

{% macro method_docstring(parameters, request_builder) %}
{% for parameter in parameters %}
{%- for doc_string in param_documentation_string(parameter).replace('\n', '\n ').split('\n') %}
{{ doc_string | wordwrap(width=95, break_long_words=False, wrapstring='\n ')}}
{% endfor %}
:{{ parameter.docstring_type_keyword }} {{ parameter.serialized_name }}: {{ parameter.docstring_type }}
{% endfor %}{%- endmacro -%}

{# error map handling #}
{% macro error_map(operation, code_model) %}
{%if operation.status_code_exceptions %}
error_map = {
    {% if not 401 in operation.status_code_exceptions_status_codes %}
    401: ClientAuthenticationError,
    {% endif %}
    {% if not 404 in operation.status_code_exceptions_status_codes %}
    404: ResourceNotFoundError,
    {% endif %}
    {% if not 409 in operation.status_code_exceptions_status_codes %}
    409: ResourceExistsError,
    {% endif %}
{% for excep in operation.status_code_exceptions %}
    {% for status_code in excep.status_codes %}
    {% set error_model = ", model=self._deserialize(_models." + excep.serialization_type + ", response)" if excep.is_exception and not code_model.no_models else "" %}
    {% set error_format = ", error_format=ARMErrorFormat" if code_model.options['azure_arm'] else "" %}
    {% if status_code == 401 %}
    401: lambda response: ClientAuthenticationError(response=response{{ error_model }}{{ error_format }}),
    {% elif status_code == 404 %}
    404: lambda response: ResourceNotFoundError(response=response{{ error_model }}{{ error_format }}),
    {% elif status_code == 409 %}
    409: lambda response: ResourceExistsError(response=response{{ error_model }}{{ error_format }}),
    {% else %}
    {% if not error_model and not error_format %}
    {{ status_code }}: HttpResponseError,
    {% else %}
    {{ status_code }}: lambda response: HttpResponseError(response=response{{ error_model }}{{ error_format }}),
    {% endif %}
    {% endif %}
    {% endfor %}
{% endfor %}
}
{% else %}
error_map = {
    401: ClientAuthenticationError, 404: ResourceNotFoundError, 409: ResourceExistsError
}
{% endif %}
error_map.update(kwargs.pop('error_map', {})){%- endmacro -%}

{% macro response_headers(response) %}
{% for response_header in response.headers %}
response_headers['{{ response_header.name }}']=self._deserialize('{{ response_header.serialization_type }}', response.headers.get('{{ response_header.name }}'))
{% endfor %}{% endmacro %}

{% macro response_headers_and_deserialization(response, code_model) %}
{% if response.headers %}
{{ response_headers(response) }}
    {% endif %}
    {% if response.is_stream_response %}
deserialized = response.stream_download(self._client._pipeline)
    {% elif response.has_body %}
        {% if code_model.no_models %}
deserialized = _loads(response.text())
        {% else %}
deserialized = self._deserialize('{{ response.serialization_type }}', pipeline_response)
        {% endif %}
    {% endif %}
{% endmacro %}

{# write grouped parameters #}
{% macro grouped_parameters(operation) %}
{% if operation.parameters.grouped %}

    {% for grouped_parameter in operation.parameters.grouped %}
{{ grouped_parameter.serialized_name }} = None
    {% endfor %}
    {% for grouper_name, grouped_parameters in operation.parameters.grouped|groupby("grouped_by.serialized_name") %}
if {{ grouper_name }} is not None:
        {% for grouped_parameter in grouped_parameters %}
    {{ grouped_parameter.serialized_name }} = {{ grouper_name }}.{{ grouped_parameter.serialized_name.lstrip('_') }}
        {% endfor %}
    {% endfor %}
{% endif %}
{% endmacro %}

{# write queryparameters #}
{% macro query_parameters(request_builder, async_mode) %}
# Construct parameters
query_parameters = kwargs.pop("params", {})  # type: Dict[str, Any]
{% for query_parameter in request_builder.parameters.query %}
    {%if query_parameter.required %}
query_parameters['{{ query_parameter.rest_api_name }}'] = {{ query_parameter.build_serialize_data_call("query") }}
    {% else %}
if {{ query_parameter.full_serialized_name }} is not None:
    query_parameters['{{ query_parameter.rest_api_name }}'] = {{ query_parameter.build_serialize_data_call("query") }}
    {% endif %}
{% endfor %}{% endmacro %}

{# write request_builder headers #}
{% macro header_parameters(code_model, request_builder, async_mode) %}
# Construct headers
header_parameters = kwargs.pop("headers", {})  # type: Dict[str, Any]
{% for header_parameter in request_builder.parameters.headers %}
    {%if header_parameter.required %}
header_parameters['{{ header_parameter.rest_api_name }}'] = {{ header_parameter.build_serialize_data_call("header") }}
    {% else %}
if {{ header_parameter.full_serialized_name }} is not None:
    header_parameters['{{ header_parameter.rest_api_name }}'] = {{ header_parameter.build_serialize_data_call("header") }}
    {% endif %}
{% endfor %}{% endmacro %}

{# path format arguments #}
{% macro path_format_arguments(path_parameters) %}
path_format_arguments = {
{% for path_parameter in path_parameters %}
    '{{ path_parameter.rest_api_name }}': {{ path_parameter.build_serialize_data_call("url") }},
{% endfor %}
}{% endmacro %}

{% macro format_path_format_arguments(url_name="url") %}
{{ url_name }} = self._client.format_url({{ url_name }}, **path_format_arguments){% endmacro %}

{# helper for non-stream body params with schema #}
{% macro serialize_body(operation) %}
{% set send_xml = "xml" if operation.parameters.has_body and "xml" in operation.parameters.content_types %}
{% set ser_ctxt = operation.parameters.body[0].xml_serialization_ctxt if send_xml else None %}
{% set body_is_xml = ", is_xml=True" if send_xml else "" %}
{% if ser_ctxt %}
serialization_ctxt = {'xml': {{ "{" }}{{ ser_ctxt }}{{ "}}" }}
{% endif %}
{% if operation.parameters.body[0].required %}
{{ operation.body_serialization_str }}
{% else %}
if {{ operation.parameters.body[0].serialized_name }} is not None:
    {{ operation.body_serialization_str }}
else:
    {{ operation.body_kwarg_to_pass_to_request_builder }} = None
{% endif %}{% endmacro %}

{% macro set_body_content_kwarg(operation, schema_request) %}
{% if schema_request.is_stream_request %}
content = {{ operation.parameters.body[0].serialized_name }}
{% elif schema_request.body_parameter_has_schema and not operation.request_builder.multipart %}
{{ serialize_body(operation) }}{% endif %}{% endmacro %}

{# write body parameters #}
{% macro body_parameters(operation) %}
{% if operation.parameters.has_body %}
    {% if (operation.request_builder.schema_requests | length) == 1 %}
{{ set_body_content_kwarg(operation, operation.request_builder.schema_requests[0]) }}
    {% else %}
content = input
        {% for schema_request in operation.request_builder.schema_requests | rejectattr("is_stream_request")%}
{{ "el" if not loop.first }}if content_type.split(";")[0] in {{ schema_request.pre_semicolon_media_types }}:
    {{ set_body_content_kwarg(operation, schema_request)|indent }}
        {% endfor %}
{% endif %}{% endif %}{% endmacro %}

{# create HTTPRequest #}
{% macro create_http_request(request_builder, is_python_3_file) %}
return HttpRequest(
    method="{{ request_builder.method }}",
    url=url,
    {% if request_builder.parameters.query %}
    params=query_parameters,
    {% endif %}
    {% if request_builder.parameters.headers %}
    headers=header_parameters,
    {% endif %}
    {% if request_builder.parameters.has_body %}
        {% if is_python_3_file %}
            {% for body_kwarg in request_builder.parameters.body_kwarg_names.keys() | list %}
    {{ body_kwarg }}={{ body_kwarg }},
            {% endfor %}
        {% endif %}
    {% endif %}
    **kwargs
)
{% endmacro %}


{% macro handle_error_response(code_model, operation) %}
if response.status_code not in {{ operation.success_status_code|string() }}:
    map_error(status_code=response.status_code, response=response, error_map=error_map)
    {% set error_model = "" %}
	{% if operation.default_exception and not code_model.no_models %}
    error = self._deserialize.failsafe_deserialize({{ operation.default_exception }}, response)
    {% set error_model = ", model=error" %}
	{% endif %}
    raise HttpResponseError(response=response{{ error_model }}{{ ", error_format=ARMErrorFormat" if code_model.options['azure_arm'] else "" }}){% endmacro %}

{# deal with response #}
{% macro handle_response(code_model, operation) %}
response = pipeline_response.http_response

{{ handle_error_response(code_model, operation) }}

{# now we only initialize deserialized to None if we know there is both > 1 response with body and > 1 response of None #}
{# otherwise, we know that deserialized will be set to a value then returned #}
{% if operation.has_optional_return_type %}
deserialized = None
{% endif %}
{% if operation.any_response_has_headers %}
response_headers = {}
{% endif %}
{% if operation.has_response_body or operation.any_response_has_headers %}
  {% if operation.responses|count > 1 %}
    {% for status_code in operation.success_status_code %}
      {% set response =  operation.get_response_from_status(status_code) %}
      {% if response.headers or response.has_body %}
if response.status_code == {{ status_code }}:
    {{ response_headers_and_deserialization(response, code_model)|indent }}
      {% endif %}
    {% endfor %}
  {% else %}
    {% set response = operation.responses[0] %}
{{ response_headers_and_deserialization(response, code_model) }}
  {% endif %}
{% endif %}
if cls:
    return cls(pipeline_response, {{ 'deserialized' if operation.has_response_body else 'None'}}, {{ 'response_headers' if operation.any_response_has_headers else '{}' }})
{% if operation.has_response_body %}

return deserialized
{% endif %}
{% if operation.request_builder.method == 'HEAD' and code_model.options['head_as_boolean'] %}
return 200 <= response.status_code <= 299
{% endif %}{% endmacro %}

{% macro get_request_builder(code_model, operation, request_builder, async_mode, url=None) %}
{% set template_url = url or "self." + operation.name + ".metadata['url']" %}
{% if request_builder.parameters.has_body %}
content_type = kwargs.pop("content_type", {{ operation.default_content_type_declaration }})
{% endif %}
{% if operation.parameters.grouped %}
{{ grouped_parameters(operation) }}
{%- endif -%}
{% if operation.request_builder.multipart %}
# Construct form data
files = {
    {% for param in operation.parameters.body %}
    '{{ param.rest_api_name }}': {{ param.serialized_name }},
    {% endfor %}
}
{% endif %}
{% if operation.parameters.is_flattened %}
{{ operation.parameters.build_flattened_object() }}
{% endif %}
{% for constant_body in operation.parameters.constant_bodies %}
{{ constant_body.serialized_name }} = {{ constant_body.constant_declaration }}
{% endfor %}
{% if operation.parameters.has_body %}
{{ body_parameters(operation) }}
{% endif %}
{% set operation_group_name = request_builder.operation_group_name %}
request = {{ "_" if not operation_group_name and not code_model.rest_layer }}rest{{ ("_" + operation_group_name) if operation_group_name }}.{{ request_builder.name }}(
{% if request_builder.parameters.method | rejectattr("is_body") | first %}
    {% for parameter in request_builder.parameters.method | rejectattr("is_body") %}
    {{ parameter.serialized_name }}={{ parameter.name_in_high_level_operation }},
    {% endfor %}
{% endif %}
{% if request_builder.parameters.has_body %}
    {{ operation.body_kwarg_to_pass_to_request_builder }}={{ operation.body_kwarg_to_pass_to_request_builder }},
    content_type=content_type,
{% endif %}
    template_url={{ template_url }},
    **kwargs
)._internal_request
{% if operation.parameters.path %}
{{ path_format_arguments(operation.parameters.path) }}
{% endif %}
request.url = self._client.format_url(request.url{{ ", **path_format_arguments" if operation.parameters.path else "" }})
kwargs.pop("content_type", None){% endmacro %}

{% macro get_example_template(builder, body_kwargs) %}
Example:
    .. code-block:: python
{% if builder.parameters.has_body and "json" in body_kwargs %}
    {% set discriminator_name = builder.parameters.json_body.discriminator_name %}
    {% if discriminator_name %}

        # {{ discriminator_name }} template as part of your input body
        {{ discriminator_name }} = '{{ builder.parameters.json_body.subtype_map.values()|join("' or '") }}'
    {% endif %}

        # JSON input template you can fill out and use as your `json` input.
        json = {{ builder.parameters.get_json_template_representation() | indent(8)}}
{% elif builder.parameters.has_body and "files" in body_kwargs %}

        # multipart input template you can fill out and use as your `files` input.
        files = {{ builder.parameters.get_files_template_representation() | indent(8)}}
{% elif builder.successful_responses_with_bodies | first %}

    {% for response in builder.successful_responses_with_bodies %}
        # response body for status code(s): {{ response.status_codes | join(', ') }}
        response_body == {{ response.get_json_template_representation() | indent(8) }}
    {% endfor %}
{% endif %}{% endmacro %}